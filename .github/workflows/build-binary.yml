name: Build binary (multiplatform)

on:
  workflow_dispatch:
  push:
    branches:
      - master
    tags:
      - '**'


jobs:
  build-binary:
    strategy:
      matrix:
        platform: [ ubuntu-latest, macos-latest-arm64, macos-latest-large, macos-latest-xlarge ] # xlarge - macos with apple silicon processor
        architecture: [ x86_64, aarch64 ]
        python-version: [ "3.8", "3.9", "3.10", "3.11", "3.12" ]
        python-version-short: [ "cp38", "cp39", "cp310", "cp311", "cp312" ]
        build-profile-os: [ manylinux, macosx ]
        build-profile-arch: [ x86_64, arm64 ]
        build-profile-platform: [ linux, macos ]
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
        
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install -U build cibuildwheel pex
          curl -Lo "science" https://github.com/a-scie/lift/releases/download/v0.3.0/science-${{ matrix.platform }}-${{ matrix.architecture }}
          chmod +x science

      - name: Build wheel
        shell: bash
        env:
          BUILD_PROFILE: "${{ matrix.python-version-short }}-${{ matrix.build-profile-os }}-${{ matrix.build-profile-arch }}"
          PLATFORM: "${{matrix.build-profile-platform}}"
        run: |
          CIBW_BUILD="${{ env.BUILD_PROFILE }}" python -m cibuildwheel --platform ${{ env.PLATFORM }} --output-dir wheelhouse src/vconf-binary
          python -m build src/pikesquares --wheel

      - name: Build PEX
        shell: bash
        env:
          PYTHON_PATH: "$(which python)"
          LATEST_BINARY_WHEEL: ""
          LATEST_CLI_WHEEL: ""
        run: |
          PEX_TOOLS=1 pex -vvv \
          wheelhouse/${{ env.LATEST_BINARY_WHEEL }} \
          src/pikesquares/dist/${{ env.LATEST_CLI_WHEEL }} \
          -r src/pikesquares/requirements/base.txt \
          --venv \
          --include-tools \
          --python ${{ env.PYTHON_PATH }} \
          --entry-point pikesquares.cli.cli:app \
          --disable-cache \
          --no-emit-warnings \
          -o vconf.pex
        
      - name: Build executable binary (science)
        shell: bash
        run: |
          science lift --file vconf-pex=vconf.pex build \
          --use-platform-suffix \
          --hash sha256 \
          vconf.toml
